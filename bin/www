// #!/usr/bin/env node
const express = require('express');
const path = require('path');
require('dotenv').config();
const app = express();
const PORT = process.env.PORT || 3001;
app.set('trust proxy', true)
app.use(express.json()); // to parse JSON bodies

// Serve static files (React build)
app.use('/api/uploads', express.static(path.join(__dirname, '../public/uploads')));

console.log('Uploads directory: ', path.join(__dirname, '../public/uploads'));

// Add this middleware to log requests
app.use('/api/uploads', (req, res, next) => {
    console.log('Upload request:', req.path);
    next();
});

// Example API route
app.get('/api/hello', (req, res) => {
  const currentTime = new Date();
  const today = currentTime.toLocaleString('en-UK'); // Example for US English locale

  res.json({ message: 'This is Hello from Flex API!', date: today });
});

app.get('/api/talk_to_ai', async (req, res) => {
  const userQuery = req.query.userQuery
  console.log("Req query... ", userQuery)
    try {
        const apiUrl = "http://13.57.185.244:5603/resume_query?query="+userQuery; // Gen AI API endpoint
        const response = await fetch(apiUrl);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        res.json(data); // Send the fetched data back to the client
    } catch (error) {
        console.error('Error fetching data:', error);
        res.status(500).json({ error: 'Failed to fetch data from GenAI API' });
    }
});

// Mount the routers at /api/...
const applicationRouter = require('../routes/application');
app.use('/api/application', applicationRouter);
const categoriesRouter = require('../routes/categories');
app.use('/api/categories', categoriesRouter);
const clientsRouter = require('../routes/clients');
app.use('/api/clients', clientsRouter);
const employeesRouter = require('../routes/employees');
app.use('/api/employees', employeesRouter);
const hiringsRouter = require('../routes/hirings');
app.use('/api/hirings', hiringsRouter);
const indexRouter = require('../routes/index');
app.use('/api/index', indexRouter);
const officeLocationsRouter = require('../routes/officeLocations');
app.use('/api/officeLocation', officeLocationsRouter);
const projectAllocationsRouter = require('../routes/projectAllocations');
app.use('/api/projectAllocations', projectAllocationsRouter);
const projectsRouter = require('../routes/projects');
app.use('/api/projects', projectsRouter);
const projectUtilizationsRouter = require('../routes/projectAllocations');
app.use('/api/projectAllocations', projectUtilizationsRouter);
const reportsRouter = require('../routes/reports');
app.use('/api/reports', reportsRouter);
const timesheetsRouter = require('../routes/timesheets');
app.use('/api/timesheets', timesheetsRouter);
const usersRouter = require('../routes/users');
app.use('/api/users', usersRouter);

app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
